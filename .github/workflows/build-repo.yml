---
name: Build Pacman Repo

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 0 * * *"

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  build-pacman-repo:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: BRAINSia/free-disk-space@v2
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false

          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          mandb: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout Pacman Repo Builder
        uses: actions/checkout@v6
        with:
          repository: pacman-repo-builder/pacman-repo-builder
          path: pacman-repo-builder

      - name: Checkout yay
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            git clone https://aur.archlinux.org/yay.git yay

      - name: Checkout this repo
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            git clone --recurse-submodules https://github.com/${{ github.repository }}.git repo || \
            (cd repo && git submodule update --init --recursive)

      - name: Get GitHub App token for GitHub Pages
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.PAGES_BOT_APP_ID }}
          private-key: ${{ secrets.PAGES_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.repository_owner }}.github.io

      - name: Checkout GitHub Pages Repo
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository_owner }}/${{ github.repository_owner }}.github.io
          ref: main
          path: github-pages
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: true
          fetch-depth: 0

      - name: Run build in Arch Linux container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v "/etc/pacman.d:/host-pacman.d" \
            -e GITHUB_WORKSPACE=/workspace \
            -e GITHUB_OUTPUT=/workspace/.github-output \
            -w /workspace \
            archlinux:base-devel \
            bash -c '
              set -e
              
              # Container setup
              pacman -Syu --disable-download-timeout --needed --noconfirm \
                archlinux-keyring \
                base-devel \
                git \
                reflector \
                wget \
                rust \
                tree

              # Build and install build-pacman-repo
              cd /workspace/pacman-repo-builder
              sed -i "s/alpm = \"[^\"]*\"/alpm = \"*\"/" Cargo.toml
              cargo update -p alpm --aggressive
              cargo build --release || (cargo fix --lib -p pacman-repo-builder && cargo build --release)
              install -Dm755 target/release/build-pacman-repo /usr/local/bin/build-pacman-repo

              # Patch makepkg
              cd /workspace/repo
              build-pacman-repo patch-makepkg --replace --unsafe-ignore-unknown-changes
              sed -i "s/COMPRESSZST=.*/COMPRESSZST=(zstd -c -T0 --ultra -20 -)/" /etc/makepkg.conf
              sed -i "s/OPTIONS=.*/OPTIONS=(strip docs !libtool !staticlibs emptydirs zipman purge !debug lto)/" /etc/makepkg.conf

              # Install yay (needs a non-root user)
              useradd -m builder
              echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
              chown -R builder:builder /workspace
              cd /workspace/yay
              su builder -c "makepkg -si --noconfirm"

              # Setup yay wrapper
              cd /workspace/repo
              chmod +x yay-noninteractive

              # Prepare sources and update SRCINFO
              sed -i "s|repository: .*|repository: /workspace/github-pages/archlinux/custom.db.tar.gz|" build-pacman-repo.yaml
              
              for dir in pkgbuilds/*/; do
                if grep -q "^pkgver()" "$dir/PKGBUILD" 2>/dev/null; then
                  echo "ðŸ“¥ Fetching sources for $(basename "$dir")..."
                  chown -R builder:builder "$dir"
                  (cd "$dir" && su builder -c "makepkg -od --nobuild --noconfirm") || true
                fi
              done
              
              echo "ðŸ”„ Updating .SRCINFO files..."
              build-pacman-repo sync-srcinfo --update
              
              echo "ðŸ“„ Current .SRCINFO files:"
              find pkgbuilds -name ".SRCINFO" -exec cat {} \;
              
              for dir in pkgbuilds/*/; do
                if [ -f "$dir/PKGBUILD" ]; then
                  echo "ðŸ§¹ Cleaning sources for $(basename "$dir")..."
                  (cd "$dir" && su builder -c "makepkg -odc --noconfirm") || true
                fi
              done

              # Check for outdated packages
              echo ""
              echo "ðŸ” Debug: Existing packages in repo directory:"
              ls -1 /workspace/github-pages/archlinux/*.pkg.tar.zst 2>/dev/null | xargs -I{} basename {} || echo "  (none)"
              
              echo ""
              echo "ðŸ” Debug: Running outdated check with full details:"
              build-pacman-repo outdated --details lossy-yaml || true
              
              echo ""
              OUTDATED=$(build-pacman-repo outdated --details pkgname)
              if [ -z "$OUTDATED" ]; then
                echo "âœ… All packages are up-to-date, nothing to build"
                echo "has_outdated=false" >> /workspace/.github-output
              else
                echo "ðŸ“¦ Outdated packages to build:"
                echo "$OUTDATED"
                echo "has_outdated=true" >> /workspace/.github-output
                
                # Build if outdated
                reflector --latest 10 --protocol http,https --sort rate --save /etc/pacman.d/mirrorlist
                test -d /workspace/github-pages/archlinux || (echo "cannot find the gh pages repo, exiting" && exit 1)
                chown -R builder:builder /workspace
                su builder -c "build-pacman-repo build" || (echo "build-pacman-repo failed" && tree -lah pkgbuilds/ && exit 2)
                
                # Verify packages
                REPO_DIR="/workspace/github-pages/archlinux"
                echo "ðŸ“¦ Packages in repository:"
                ls -lah "$REPO_DIR/"*.pkg.tar.zst 2>/dev/null || echo "  (none found)"
                PKG_COUNT=$(find "$REPO_DIR" -maxdepth 1 -name "*.pkg.tar.zst" | wc -l)
                if [ "$PKG_COUNT" -eq 0 ]; then
                  echo "ERROR: No packages found in repository"
                  exit 3
                fi
                echo "âœ… Found $PKG_COUNT package(s):"
                find "$REPO_DIR" -maxdepth 1 -name "*.pkg.tar.zst" -exec basename {} \;
              fi
            '

      - name: Read build output
        id: check-outdated
        run: |
          if [ -f .github-output ]; then
            cat .github-output >> $GITHUB_OUTPUT
          else
            echo "has_outdated=false" >> $GITHUB_OUTPUT
          fi

      - name: GitHub Commit & Push
        if: steps.check-outdated.outputs.has_outdated == 'true' && (github.event_name == 'schedule' || github.event_name == 'push')
        uses: actions-js/push@v1.5
        with:
          author_email: ${{ secrets.GH_BOT_EMAIL }}
          author_name: ${{ secrets.GH_BOT_NAME }}
          repository: ${{ github.repository_owner }}/${{ github.repository_owner }}.github.io
          branch: main
          directory: github-pages
          github_token: ${{ steps.app-token.outputs.token }}
          message: "Update per ${{ github.event_name }}: ${{ github.sha }}"
